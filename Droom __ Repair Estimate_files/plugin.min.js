var DroomChat=DroomChat||new function(){this.socket,this.iframe;var self=this;this.bind=function(){this.getUid()&&(this.loadjscssfile(this.getHost("/css/plugin.css"),"css"),this.loadjscssfile(this.getHost("/socket.io/socket.io.js"),"js",self.initSocket)),$("body").on("click",".chat-container",function(){var sI=setInterval(function(){$("#droom_chat").css("right",$(".chat-container").width()+30+"px"),348!==$(".chat-container").width()&&198!==$(".chat-container").width()||clearInterval(sI)},20)}),self.render_html()},this.moveJoeHukam=function(){0<$(".chat-container").length&&$(".mobile-chat-container").hasClass("joe-hide")?$("#droom_chat").css("right",$(".chat-container").width()+30+"px"):0<$(".mobile-chat-container").length&&$("#droom_chat").css("right","0px")},this.getParam=function(name,url){url||(url=window.location.href),name=name.replace(/[\[\]]/g,"\\$&");var results=new RegExp("[?&]"+name+"(=([^&#]*)|&|#|$)").exec(url);return results?results[2]?decodeURIComponent(results[2].replace(/\+/g," ")):"":null},this.render_html=function(){var init_chat=self.getParam("init_chat");if("menu"===init_chat){if(!1===self.getUid())return!1;var params={source_id:self.getUid(),token:self.getToken()};self.renderChat(params,"rooms")}else if(null!==init_chat){if(!1===self.getUid())return!1;$("#droom_chat")&&$("#droom_chat").remove();var action=self.getParam("chat_action")?self.getParam("chat_action"):"chat",checkSocketIntrvl=setInterval(function(){self.socket&&(self.init_chat(parseInt(init_chat),action),clearInterval(checkSocketIntrvl))},50)}$("body").on("click",".droom-chat-init",function(){var action=$(this).data("action")?$(this).data("action"):"chat";if(!1===self.getUid())return self.handleLogin($(this).data("id"),action);$("#droom_chat")&&$("#droom_chat").remove(),self.init_chat($(this).data("id"),action)}),$("body").on("click",".droom-chat-close",function(){$("#droom_chat").remove()}),$("body").on("click",".chat[role=global]",function(){if(!1===self.getUid())return self.handleLogin("rooms");if(self.isAlreadyOpened())return!1;var params={source_id:self.getUid(),token:self.getToken()};self.renderChat(params,"rooms")}),$("body").on("click",".stickyBtnFooter a[href$=inbox]",function(){if(!1===self.getUid())return self.handleLogin("rooms");if(self.isAlreadyOpened())return!1;var params={source_id:self.getUid(),token:self.getToken()};return self.renderChat(params,"rooms"),!1}),$(window).on("blur focus click",function(e){if($(this).data("prevType")!=e.type)switch(e.type){case"blur":case"focus":DroomChat.blinkTitleStop()}$(this).data("prevType",e.type)})},this.init_chat=function(object_id,action){self.socket&&self.socket.emit("init_chat",object_id,self.getUid(),action)},this.getMobileInboxButton=function(){return $(".stickyBtnFooter a[href$=inbox]")},this.renderChat=function(params,action){if(this.renderContainer(),"chat"===action){var url=this.getHost("/chat?"+$.param(params));this.renderIframe(url)}else if("rooms"===action){url=this.getHost("/rooms?"+$.param(params));this.renderIframe(url)}},this.renderContainer=function(){if(0<$("#droom_chat").length)return!1;var container=document.createElement("div");container.setAttribute("id","droom_chat"),container.setAttribute("class","droom-chat-container"),container.setAttribute("style","display: none"),$("body").append(container),$(container).slideDown(),self.moveJoeHukam(),$("<div class='droom-chat-loading'><i class='fa fa-gear fa-spin fa-2x'></i> <br> Loading...</div>").appendTo(container),$("<div class='droom-chat-close'><i class='fa fa-times'></i></div>").appendTo($("#droom_chat"))},this.renderIframe=function(url){if($("#droom_chat_frame")&&$("#droom_chat_frame").attr("src")==url)return $("#droom_chat").find(".iframe-loading").hide(),!1;this.iframe=document.createElement("iframe"),this.iframe.setAttribute("src",url),this.iframe.setAttribute("id","droom_chat_frame"),this.iframe.setAttribute("frameBorder","0"),$(this.iframe).on("load",function(){$("#droom_chat").find(".iframe-loading").hide()}),$("#droom_chat").append(this.iframe)},this.getHost=function(path){if($("#chat_js")){var url=$("#chat_js").attr("src");return parser=document.createElement("a"),parser.href=url,host=parser.protocol+"//"+parser.hostname+(parser.port?":"+parser.port:"")+(path||""),host}return path},this.loadjscssfile=function(filename,filetype,callback){if("js"==filetype){var loaded,script=document.createElement("script");script.setAttribute("src",filename),callback&&(script.onreadystatechange=script.onload=function(){loaded||callback(),loaded=!0}),document.getElementsByTagName("head")[0].appendChild(script)}else if("css"==filetype){var fileref=document.createElement("link");fileref.setAttribute("rel","stylesheet"),fileref.setAttribute("type","text/css"),fileref.setAttribute("href",filename),document.getElementsByTagName("head")[0].appendChild(fileref)}},this.isAlreadyOpened=function(){return 0<$("#droom_chat_frame").length},this.handleLogin=function(from,action){window.location.href="/user/login?dest="+window.location.pathname+"?init_chat="+from},this.getUid=function(){return!!$("#chat_js")&&(0<parseInt($("#chat_js").data("uid"))&&parseInt($("#chat_js").data("uid")))},this.getToken=function(){return!!$("#chat_js")&&$("#chat_js").data("token")},this.updateCounts=function(count){0<parseInt(count)?($(".unread_chat_messages").parent(".link").addClass("has"),$(".unread_chat_messages").text(count).removeClass("hidden"),this.getMobileInboxButton()&&(this.getMobileInboxButton().find(".unread_chat_messages").remove(),this.getMobileInboxButton().append('<span class="mobile unread_chat_messages">'+count+"</span>"))):($(".unread_chat_messages").parent(".link").removeClass("has"),$(".unread_chat_messages").addClass("hidden"))},this.limitReached=function(message){alert(message)},this.initSocket=function(){var host=DroomChat.getHost("/rooms");self.socket=io(host,{transports:["websocket"]}),self.socket.on("disconnect",function(reason){self.socket.connect()}),self.socket.on("connect",function(){self.socket.emit("join_droom",DroomChat.getUid()),self.socket.on("update_counter",function(count){DroomChat.updateCounts(count)}),self.socket.on("add_to_cart",function(listing_id){$.ajax({url:"/add_to_cart?listing_id="+listing_id+"&old_data=1&cart_reset=1",type:"get",dataType:"json",success:function(data){if("success"==data.code){var count=data.data.item_count;$("#cart_count").html(count),window.location.href="/cart-summary"}else if("failed"==data.code)return data.errors[0]&&DroomApp.show_msg(data.errors[0],"error",5e3),!1}})}),self.socket.on("notify_chat",function(params,title){DroomChat.blinkTitleStop(),DroomChat.updateCounts(params.count),self.socket.emit("delivered",params.message_id,params.source_id),DroomChat.blinkTitle(title),setTimeout(function(){DroomChat.blinkTitleStop()},1e4),$(window).on("blur focus",function(e){if($(this).data("prevType")!=e.type)switch(e.type){case"blur":case"focus":DroomChat.blinkTitleStop()}$(this).data("prevType",e.type)})}),self.socket.on("init_chat_res",function(action,message,data,chat_action){if("CHAT"===action){var params={source_id:DroomChat.getUid(),token:DroomChat.getToken(),room_id:data._id};"best_offer"===chat_action&&(params.best_offer=1),DroomChat.renderChat(params,"chat")}else"SUBSCRIBE"===action?"undefined"!=typeof DroomApp&&DroomApp.show_subscription_popup({from:"chat",type:data.buyer_subscription_type,message:message}):"UNVERIFIED"===action?"undefined"!=typeof DroomApp&&DroomApp.show_msg(message,"error"):"ERROR"===action&&"undefined"!=typeof DroomApp&&DroomApp.show_msg("Something went wrong, please try again","error")})})};var title=document.title,interval=0;this.blinkTitle=function(title1,title2,timeout){title2=title2||title,timeout=timeout||1e3,document.title=title1,interval=setInterval(function(){document.title==title1?document.title=title2:document.title=title1},timeout)},this.blinkTitleStop=function(){clearInterval(interval),document.title=title}};$(function(){DroomChat.bind()});